notify:
  - name: default
    platform: group
    services: []

automation:
  id: default_notifier_automation
  alias: Default Notifier
  description: >-
    Intercepts calls to the default notification group and reprocesses with
    default settings. Sets title if not provided. Handles critical notifications
    by converting critical flag to iOS critical alert format.
  triggers:
    - alias: Notification group called
      event_data:
        domain: notify
        service: default
      event_type: call_service
      trigger: event
      id: notified
  actions:
    - if:
      - condition: trigger
        id:
          - notified
      then:
        - alias: Build notification data
          variables:
            service_data: "{{ trigger.event.data.service_data | default({}) }}"
            data: "{{ service_data.data | default({}) }}"
            is_critical: "{{ data.get('critical', false) }}"
            notification_title: "{{ service_data.title | default(state_attr('zone.home', 'friendly_name')) }}"
            notification_message: "{{ service_data.message | default('') }}"
            notification_data: >-
              {% if is_critical %}{{ dict(data.items() | rejectattr('0', 'eq',
              'critical') | list, push={'sound': {'name': 'Update.caf', 'critical': 1,
              'volume': 1.0}}) }}{% else %}{{ data }}{% endif %}
        - alias: Send to each recipient
          repeat:
            for_each:
              - << default_notifier >>
            sequence:
              - alias: Send notification
                action: notify.{{ repeat.item }}
                data:
                  title: "{{ notification_title }}"
                  message: "{{ notification_message }}"
                  data: "{{ notification_data }}"
  max: 10
  mode: queued
